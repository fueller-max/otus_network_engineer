###    STP. Развертывание коммутируемой сети с резервными каналами"


###  Задание:

1. Создание сети с избыточными связями и настройка основных параметров устройства
2. Определение корневого моста
3. Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов
4. Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов



###  Решение:
1. [Создание сети с избыточными связями и настройка основных параметров устройства](Readme.md#1-создание-сети-с-избыточными-связями-и-настройка-основных-параметров-устройства)

2. [Определение корневого моста](Readme.md#2-определение-корневого-моста)

3. [Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов](Readme.md#3-наблюдение-за-процессом-выбора-протоколом-stp-порта-исходя-из-стоимости-портов)

4. [Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов](Readme.md#4-наблюдение-за-процессом-выбора-протоколом-stp-порта-исходя-из-приоритета-портов)

<br>

### 1. Создание сети с избыточными связями и настройка основных параметров устройства

<br>

![](/Labs/Lab02/pics/Topology_EVE-NG.png)

Рис1. Топология сети из трех коммутаторов - S1, S2, S3 и избыточныи связями между ними

<br>

#### Таблица адресации 

|Устройство|Интерфейс|IP-адрес|Маска подстети|
|---:|:---:|:--:|:----:|
|S1|VLAN1|192.168.1.1|/24|
|S2|VLAN1|192.168.1.2|/24|
|S3|VLAN1|192.168.1.3|/24|

<br>

#### Проверка связи между коммутаторами

ping: S1>S2

![](/Labs/Lab02/pics/ping_S1_to_S2.png)

ping: S1>S3

![](/Labs/Lab02/pics/ping_S1_to_S3.png)

ping: S2>S3

![](/Labs/Lab02/pics/ping_S2_to_S3.png)

<br>

### 2. Определение корневого моста

<br>

Результат вывода команды **show spanning tree** для S1:

![](/Labs/Lab02/pics/S1_STP.png)

<br>

Результат вывода команды **show spanning tree** для S2:
![](/Labs/Lab02/pics/S2_STP.png)

<br>

Результат вывода команды **show spanning tree** для S3:
![](/Labs/Lab02/pics/S3_STP.png)


<br>

Роль и состояние (Sts) активных портов на каждом коммутаторе в топологии

![](/Labs/Lab02/pics/Port_states.png)

<br>

## Ответьте на следующие вопросы:

### Какой коммутатор является корневым мостом? 

 Корневым мостом является коммутатор S23 

 ### Почему этот коммутатор был выбран протоколом spanning-tree в качестве корневого моста?

 Приоритет у всех коммутаторов выставлен по умолчанию - 32769 (32768 + 1 (VLAN1)), поэтому с этой точки зрения все коммутаторы имеют равный статус стать корневыми. Для выбора корневого коммутатора в условиях равного приоритета система обратилась к сравнению MAC адресов. Коммутатор с наименьшим значением MAC выбирается в качестве корневого. В данном случае наименьший MAC у коммутатора S2. 

### Какие порты на коммутаторе являются корневыми портами? 

1. На коммутаторе S1 корневым портом является G0/0
2. На коммутаторе S3 корневым портом является G0/0
3. На коммутаторе S2 нет корневых портов, т.к. он является корневым

### Какие порты на коммутаторе являются назначенными портами? 

1. На коммутаторе S1 назначенные порты G1/0-G1/3 (порты конечных устройств).
2. На коммутаторе S3 назначенные порты G1/0-G1/3 (порты конечных устройств) + G0/2, G0/3
3. На коммутаторе S2 все порты являются назначенными,  т.к. он является корневым


### Какой порт отображается в качестве альтернативного и в настоящее время заблокирован?

1. На коммутаторе S1 альтернативными портами являются G0/1, G0/2, G0/3. В данный момент заблокированы
2. На коммутаторе S3 альтернативным портом является порт G0/1. В данный момент заблокирован

### Почему протокол spanning-tree выбрал этот порт в качестве невыделенного (заблокированного) порта?

Решение о выборе блокировки порта принимается на основании
- стоимости пути (скорости порта)
- BID отправителя
- приоритет порта


1. В данном случае на коммутаторе S1 порты G0/2 и G0/3 заблокированы из-за стоимости пути до корневого свитча. Порт G0/1 порт заблокирован, как имеющий более высокий BID по сравнению с G0/0.

2. На коммутаторе S3 порт G0/1 порт заблокирован, как имеющий более высокий BID по сравнению с G0/0.


### 3. Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов

Изменим стоимость корневого порта G0/0 коммутатора S1 с 4 до 2.

![](/Labs/Lab02/pics/S1_change_cost_G0_0.png)


Выполним команды spanning-tree на некорневых коммутаторах S1 b S2.

![](/Labs/Lab02/pics/S1_spanning_tree_after_chg_cost.png)

<br>

![](/Labs/Lab02/pics/S3_spanning_tree_after_chg_cost.png)


Графически состояние портов стало иметь такой вид:

![](/Labs/Lab02/pics/Port_change_after_change.png)


Как видно, ранее Designated порты  G0/2, G0/3 на коммутаторе S3 сейчас находятся в Alternative заблокированном состоянии (ранее были в состоянии Designated). А на коммутаторе S1 наборот, порты  G0/2, G0/3 сейчас находятся в  Designatedсостоянии (ранее были в состоянии Alternative blocked)

Связано это с с тем, что снизилась стоимость Root у порта G0/0 коммутатора S1, соответственно порты G0/2, G0/3 становятся Designated как дающие более оптимальный путь до Root коммутатора. 

<br>

Возвращаем  стоиомсть порта  G0/0 коммутатора S1 с 2 до 4

![](/Labs/Lab02/pics/S1_change_cost_G0_0_back.png)



Выполним команды spanning-tree на некорневых коммутаторах S1 и S2.

![](/Labs/Lab02/pics/S1_spanning_tree_after_chg_cost_back.png)

<br>

![](/Labs/Lab02/pics/S3_spanning_tree_after_chg_cost_back.png)


Как видно, STP пересчитал пути и вернул состояние портов на обоих коммутаторах -S1, S3 к изначальному состоянию.


### 4. Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов

Заблокируем порты G0/0 на коммутаторах S1 и S3. После этого, Root порты перемещены на порты G0/1.

<b>

![](/Labs/Lab02/pics/S1_spanning_tree_port_priority.png)

<b>

![](/Labs/Lab02/pics/S3_spanning_tree_port_priority.png)


Включаем обратно порты G0/0 на коммутаторах S1 и S3. Как видно, STP вернул обратно Root порты на G0/0

<br>

![](/Labs/Lab02/pics/S1_spanning_tree_port_priority_back.png)


<br>

![](/Labs/Lab02/pics/S3_spanning_tree_port_priority_back.png)


Таким образом,  протокол STP после сравнения BID, в качестве факторов использует приоритет порта (он одинаков тут) и номер порта. Более низкие значения -предпочтительны. 

<br>


## Вопросы для повторения

#### 1.	Какое значение протокол STP использует первым после выбора корневого моста, чтобы определить выбор порта?

Стоимость порта

#### 2.	Если первое значение на двух портах одинаково, какое следующее значение будет использовать протокол STP при выборе порта?

BID

#### 3.	Если оба значения на двух портах равны, каким будет следующее значение, которое использует протокол STP при выборе порта?

Приоритет порта